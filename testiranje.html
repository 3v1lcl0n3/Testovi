<html lang="en">
  <head>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link  rel="stylesheet" href="css/style_dva.css">
	<style>
	#smartguide-1251422910{
	visibility: hidden;
	}
	
	#Task_form,.tekst{
	touch-action: none;
	}
	
	.tekst,#id{
	-webkit-user-select: none;
	-khtml-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
	-o-user-select: none;
	user-select: none;
	
	}
	
	#selekcija {
	background: tomato;
	color:white;
	}
	</style>
	
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="HandheldFriendly" content="true"/>
	<title>Keyboard Experiment</title>
	<link rel="stylesheet" href="./dist/myscript.min.css"/>
	<link rel="stylesheet" href="./examples/examples.css">
	<script src="https://code.jquery.com/pep/0.4.3/pep.js"></script>
	<script type="text/javascript" src="./dist/myscript.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script> <!-- File saver skripta -->
	<script src = "js/login_script.js"></script> <!--Moja skripta u kojoj je save (ime funkcije: downloadResults(var string) -->
  </head>
  
  <body>	
  <div class = "container" id="container">
  <script>
  

  var start = performance.now();
  var rightMouseClicked = false;
  var za_ispis = "";
  var user_log = "";
  var count = 0;
  var flag_input = 0;
  var flag_action = 0;
  var zadatak = 0;
  var rijesenje = "";
  var tekst_prepis = "99";
  var clipboard = "";
  var recenice = ["Materijal za izradu domaćih zadaća je na zajedničkom repozitoriju", 
				"Rok za predaju će biti naknadno dogovoren", 
				"Naći ćemo se u predvorju Pomorskog fakulteta u Rijeci (prizemlje)",
				"Pošaljite mail ako je nešto slučajno ostalo nejasno",
				"Podaci za Graz se mogu preuzeti s NASA-inog IGS poslužitelja",
				"Cilj ove vježbe je uspostaviti radno okruženje R na svom osobnom računalu",
				"Iscrtavanje GNSS pogrešaka položaja na OSM karti",
				"Na najljepšem zaljevu na svijetu nema mjesta za jednog od nas",
				"Inteligencija - obilježje uspješnog snalaženja u novim situacijama",
				"Možda je to netko tako namjerno napravio",
				"KRAJ ZADATKA"];
  
  document.onkeydown = keydown; 
  
  var device = localStorage.getItem('device');

  var student_id = localStorage.getItem('student_id');
  
  function loggaj(){
  console.log("tu sam")
  user_log = user_log + document.getElementById("Task_output2").value + "\n";
  
  }
  
  function downloadResults(string,type) {
	var blob = new Blob([string], {type: "text/plain;charset=utf-8"});
	var date = new Date();
	var currentDate = [date.getFullYear(), date.getMonth(), date.getDate()].join('');
	var currentTime = [date.getHours(), date.getMinutes(), date.getSeconds()].join('');
	var fileName = type + "_" + student_id + "_" + device + "_" + currentDate + "_" + currentTime + ".csv";
	saveAs(blob, fileName);
}
  
  
  console.log(device, student_id);
  
	async function keydown (evt) { 
    if (!evt) evt = event; 
    if (evt.ctrlKey && evt.keyCode === 86) {
		if (zadatak == 1 && flag_input == 1 && device == "keyboard"){
		flag_action = 1;
		//document.getElementById("Task_input").value = await navigator.clipboard.readText();
		document.getElementById("result").innerHTML = "Gremo dalje";
		}
		 
    } else if (evt.ctrlKey && evt.keyCode === 67) { 
        if (zadatak == 2 && flag_input == 1 && device == "keyboard"){
		flag_action = 1;
		document.getElementById("result").innerHTML = "Gremo dalje";
		}
		
    } else if (evt.ctrlKey && evt.keyCode === 88) { 
        if (zadatak == 3 && flag_input == 1 && device == "keyboard"){
		flag_action = 1;
		document.getElementById("result").innerHTML = "Gremo dalje";
		}
    } else if (evt.ctrlKey && evt.keyCode === 90) { 
        if (zadatak == 4 && flag_input == 1 && device == "keyboard"){
		flag_action = 1;
		document.getElementById("result").innerHTML = "Gremo dalje";
		}
    } else if (evt.ctrlKey && evt.keyCode === 89) { 
        if (zadatak == 4 && flag_input == 1 && device == "keyboard"){
		flag_action = 1;
		document.getElementById("result").innerHTML = "Gremo dalje";
		}
    }

}

  
  function zadatak_cpaste(tekst_zad){
  zadatak = 1;
  document.getElementById("ime_zad").innerHTML = "Akcija: Paste";
  tekst_prepis = tekst_zad;
  var word_array = tekst_zad.split(" ");
  var rnd_word = word_array[Math.floor(Math.random() * word_array.length)];
  rijesenje = rnd_word;
  //za tipkovnicu i mis
  if(device == "keyboard") {
  document.getElementById("opis_zad").innerHTML = "Napiši rečenicu \"" + tekst_zad +"\", potom označi riječ \"" + rnd_word + "\" - Zatim kopiraj riječ"+ rnd_word +" kopiraj kraticom ctr + c, označi donji prostor i zalijepi kraticom ctrl + v.";
  document.getElementById("Task_output2").style.visibility = "visible";
  //document.getElementById("Task_input").style.display = "none";
  
  }
  //za tablet
  if(device == "tablet") document.getElementById("opis_zad").innerHTML = "Napiši rečenicu \"" + tekst_zad +"\", potom označi riječ \"" + rnd_word + "\" - kopiraj ju izradom geste u obliku kruga i onda odabirom donjeg prostora i rađenje geste check.";
  
  
  
  }
  
  
  /*function zadatak_copy(){
  zadatak = 2;
  document.getElementById("ime_zad").innerHTML = "Akcija: Copy";
  //za tipkovnicu i mis
  if(device == "keyboard") document.getElementById("opis_zad").innerHTML = "Zadatak: oznaci tekst untar prozora i pritisni kraticu za opciju copy(tipka control + tipka c na tipkovnici)";
  
  //za tablet
  if(device == "tablet") document.getElementById("opis_zad").innerHTML = "Zadatak: oznaci tekst untar prozora i napravi gestu u obliku slova C";
  }
  */
  function zadatak_cut(){
  zadatak = 3;
  document.getElementById("ime_zad").innerHTML = "Akcija: Cut";
  //za tipkovnicu i mis
  if(device == "keyboard") {
  document.getElementById("opis_zad").innerHTML = "Zadatak: oznaci tekst untar prozora i pritisni kraticu za opciju cut(tipka control + tipka x na tipkovnici)";
  document.getElementById("Task_input").style.display = inline;
  //document.getElementById("Task_input").style.display = none;
  }
  //za tablet
  if(device == "tablet") document.getElementById("opis_zad").innerHTML = "Zadatak: oznaci tekst untar prozora i napravi gestu u obliku slova X";
  }
  
  function zadatak_undo(){
  zadatak = 4;
  document.getElementById("ime_zad").innerHTML = "Akcija: Undo";
  //za tipkovnicu i mis
  if(device == "keyboard") document.getElementById("opis_zad").innerHTML = "Zadatak: pritisni kraticu za opciju undo(tipka control + tipka z na tipkovnici)";
  
  //za tablet
  if(device == "tablet") document.getElementById("opis_zad").innerHTML = "Zadatak: napravi gestu u obliku slova u za opciju undo";
  }
  
  function zadatak_redo(){
  zadatak = 5;
  document.getElementById("ime_zad").innerHTML = "Akcija: Redo";
  //za tipkovnicu i mis
  if(device == "keyboard") document.getElementById("opis_zad").innerHTML = "Zadatak: pritisni kraticu za opciju re-do(tipka control + tipka y na tipkovnici)"
  
  //za tablet
  if(device == "tablet") document.getElementById("opis_zad").innerHTML = "Zadatak: napravi gestu u obliku slova R";
  }
  
  function zad_focus(){
  flag_action = 1;
  }
  
  function zad_blur(){
  flag_action = 0;
  }
  
  /*function kreniTest(){
  
  console.log("test");
  //document.getElementById("login").style.visibility = "hidden";
  //document.getElementById("Task_form").style.visbility = "visible";
  
  //postavi neki zadatak
  tekst_prepis = "kratko"
  zadatak_cpaste(tekst_prepis);
  
  }*/
  
  function set_zad(){
  var flag_input = 0;
  var flag_action = 0;
  var rijesenje = "";
  var tekst_prepis = "99";
  var clipboard = "";
  document.getElementById("Task_input").value = "";
  document.getElementById("Task_output").value = "";
  document.getElementById("Task_output2").value = "";
  for(var i = 0; i< 150; i++){
	editorElement.editor.undo();
  }
  
  zadatak_cpaste(recenice[count]);
  count++;
  
	
  }
  
  
  function check(){
  
	if(document.getElementById("Task_output").value == tekst_prepis && document.getElementById("Task_input").value == rijesenje) alert("ovo je super?");
	if(document.getElementById("Task_output2").value == tekst_prepis && document.getElementById("Task_input").value == rijesenje) {
	set_zad();
	var time_split =  performance.now();
	za_ispis = za_ispis + "Zadatak: " + (count - 1) + ", vrijeme: " + ((time_split - start)/ 1000).toFixed(2) + "s\n";
	start = time_split;
	if (count == 11){
		downloadResults(za_ispis, "Time_Log");
		downloadResults(user_log, "User_Log");
		document.getElementById("tekst_zad").innerHTML = "";
		document.getElementById("Opis").innerHTML = "Gotovi ste s modalitetom rada";
	}
	
	}
	console.log(document.getElementById("Task_output").value);
	console.log(tekst_prepis);
	console.log(document.getElementById("Task_input").value);
	console.log(rijesenje);
  }
  
  </script>
  
<!-- <form id="login">
  ID:<br>
  <input type="text" name="identification"><br>
  <input type="radio" name="input_type" value="Pen" checked> Pen<br>
  <input type="radio" name="input_type" value="keyboard + Mouse"> Keyboard + Mouse<br>
  <input type="button" value="let's go" onclick="kreniTest()">
</form> -->
  <div style='text-align: center;' id="Task_form">
  
	<h1 class="tekst" id="ime_zad"> Ime Zadatka</h1>
	<h3 class="tekst" id="opis_zad"> Opis Zadatka</h3>
	<br> <br>
	<div  id="action_part">
		<h3 id="Task_output" contenteditable="true" tabindex="0">
		</h3>
		<input class = "form-control" type="text" id="Task_output2" onfocus="zad_focus()" onblur="zad_blur()" oninput="loggaj()" style="visibility:hidden;" >
		<br class="tekst">
		<br class="tekst">
		<br class="tekst">
		<h4 class="tekst">Ovdje zalijepiti:</h4> <br> <br>
		<input class = "form-control" type="text"id="Task_input" onfocus="zad_focus()" onblur="zad_blur()" oninput="check()" onkeypress='validate(event)' ><br>
	</div>
	<h3 class="tekst" id='result' >Result: </h3>
	<br> <br> <br>
	<div>
  <nav>
    <div class="button-div">
      <button id="undo" class="nav-btn btn-fab-mini btn-lightBlue" disabled>
        <img src="./assets/undo.svg">
      </button>
      <button style="visibility:hidden;" id="redo" class="nav-btn btn-fab-mini btn-lightBlue" disabled>
        <img src="./assets/redo.svg"> 
      </button>
    </div>
    <select id="language"></select>
  </nav>
  <div id="editor" touch-action="none"></div>
</div>
  </div>
  <canvas id="gestures_canvas" height="200" width="200">
  </canvas>
  <script type="text/javascript" src="./gestures.js" ></script>
    <script type="text/javascript">
function callback(name)
{
	//document.getElementById("result").innerHTML = "Result: " + name;
	console.log(zadatak);
	console.log(flag_input);
	console.log(device);
	console.log(name);
	console.log(flag_action);
	user_log = user_log + name + "\n";
	
	if (zadatak == 1 && flag_input == 1 && device == "tablet" && name == "Paste" && flag_action == 1 && rightMouseClicked == true){
		document.getElementById("Task_input").value = clipboard;
		document.getElementById("result").innerHTML = "Pasted";
		
		if(document.getElementById("Task_input").value == rijesenje) {
		set_zad();
		var time_split =  performance.now();
		za_ispis = za_ispis + "Zadatak: " + (count - 1) + ", vrijeme: " + ((time_split - start)/ 1000).toFixed(2) + "s\n";
		start = time_split;
		if (count == 2){
			downloadResults(za_ispis, "Time_Log");
			downloadResults(user_log, "User_Log");
		}
			}
		}
	else if (zadatak == 2 && flag_input == 1 && device == "tablet" && name == "Copy"){
		flag_action = 1;
		document.getElementById("result").innerHTML = "Gremo dalje";
	}
	else if (zadatak == 3 && flag_input == 1 && device == "tablet" && name == "Line"){
		flag_action = 1;
		document.getElementById("result").innerHTML = "Gremo dalje";
	}
	/*else if (zadatak == 4 && flag_input == 1 && device == "tablet" && name == "Triangle"){
		flag_action = 1;
		document.getElementById("result").innerHTML = "Gremo dalje";
	}*/
	else if (zadatak == 5 && flag_input == 1 && device == "tablet" && name == "Check"){
		flag_action = 1;
		document.getElementById("result").innerHTML = "Gremo dalje";
	}
	
	if(rightMouseClicked == true && name == "Undo"){
	document.getElementById("result").innerHTML = "Undone";
	editorElement.editor.undo();
	editorElement.editor.undo();
	}
	/*if(name == "Check"){
	alert("nuuh");
	editorElement.editor.undo();
	editorElement.editor.redo();
	}*/
	
	
	if(rightMouseClicked == true && name == "Copy"){
	document.getElementById("result").innerHTML = "Copied";
	flag_input = 1;
	}
	
	
	
}

 //bruv ovo ce valjda spasit sve
var p = document.getElementById("Task_output");
var old = p.innerHTML;
var input = document.querySelector('input');

p.addEventListener('blur', () => {
   highlight(select()); // save the selection
})
p.addEventListener('focus', () => {
  restore(); // restore the selection
})

function highlight(r) {
  if (!r) return;

  var extracted = r.extractContents();
  
  el = document.createElement('span');
  el.id = "selekcija";
  el.appendChild(extracted);
  r.insertNode(el)
}

function select() {
  
  if (window.getSelection) {
	clipboard = window.getSelection().toString();
    sel = window.getSelection();
	
    if (sel.getRangeAt && sel.rangeCount) {
      return sel.getRangeAt(0);
    }
  } else if (document.selection && document.selection.createRange) {
    return document.selection.createRange();
  }
  return null;
}

function restore() {
  p.innerHTML = old;
}
  // ja se nadam

var gest = new gestures({
	debug: true,
	draw: true,
	drawColor: "#000000",
	drawWidth: 5,
	autoTrack: true,
	allowRotation: true,
	inverseShape: true,
	points: 33
});

gest.addGesture("Line", [
	{x: 0, y: 0},
	{x: 0, y: 100}
], callback);
/*
gest.addGesture("Square", [
	{x: 0, y: 0},
	{x: 200, y: 0},
	{x: 200, y: 200},
	{x: 0, y: 200},
	{x: 0, y: 0}
], callback);

gest.addGesture("Rectangle", [
	{x: 0, y: 0},
	{x: 210, y: 0},
	{x: 210, y: 100},
	{x: 0, y: 100},
	{x: 0, y: 0}
], callback);
*/
gest.addGesture("Undo", [
	{x: 0, y: 0},
	{x: 50, y: 87},
	{x: 100, y: 0},
	{x: 150, y: 87}
], callback);
/*
gest.addGesture("Triangle", [
	{x: 0, y: 0},
	{x: 100, y: 100},
	{x: 0, y: 100},
	{x: 0, y: 0}
], callback);
*/
gest.addGesture("Paste", [
	{x: 0, y: 0},
	{x: 50, y: 50},
	{x: 100, y: 0},
], callback);

var x = 0;
var y = -100;
var circle = [];
var totalPoints = 72;
var step = (Math.PI*2)/totalPoints;

for(var angle = 1; angle < totalPoints; angle++)
{
	var newX = x*Math.cos(angle*step)-y*Math.sin(angle*step);
	var newY = y*Math.cos(angle*step)+x*Math.sin(angle*step);
	var point = {x: newX, y: newY};
	circle.push(point);
}

gest.addGesture("Copy", circle, callback)
</script>
<script>
	document.addEventListener("contextmenu", function(e){
    e.preventDefault();
	
}, false);


	function validate(evt) {
   var theEvent = evt || window.event;
   var key = theEvent.charCode || theEvent.which;
	
   if(key >= 32 && (theEvent.ctrlKey === undefined || !theEvent.ctrlKey)) {
		if(theEvent.preventDefault) theEvent.preventDefault();
		else theEvent.returnValue = false;
	}
	
	
	}
  var editorElement = document.getElementById('editor');

  var languageElement = document.getElementById('language');
  var undoElement = document.getElementById('undo');
  var redoElement = document.getElementById('redo');
  var resultElement = document.getElementById('export-result');
  
  editorElement.addEventListener('changed', function (event) {
    undoElement.disabled = !event.detail.canUndo;
    redoElement.disabled = !event.detail.canRedo;
  });

  editorElement.addEventListener('loaded', function (evt) {
    /**
     * Retrieve the list of available recognition languages
     * @param {Object} The editor recognition parameters
     */
    var currentLanguage = "hr_HR"
    var res = MyScript.getAvailableLanguageList();

    if (languageElement.options.length === 0) {
      Object.keys(res.result).forEach(function (key) {
        var selected = currentLanguage === key;
        languageElement.options[languageElement.options.length] = new Option(res.result[key], key, selected, selected);
      });
    }
  });

  languageElement.addEventListener('change', function (e) {
    var configuration = editorElement.editor.configuration;
    //The path to the language depend of the version of API you are using.
    configuration.recognitionParams.v4.lang = e.target.value;
    editorElement.editor.configuration = configuration;
  });

  undoElement.addEventListener('click', function () {
    editorElement.editor.undo();
  });
  redoElement.addEventListener('click', function () {
    editorElement.editor.redo();
  });
	
	editorElement.addEventListener('exported', function (evt) {
        if (evt.detail) {
        var export_string = JSON.stringify(evt.detail);
		var num = export_string.search('"text/plain"') + 14;
		console.log(num);
		var plain_text = export_string.slice(num);
		plain_text = plain_text.substring(0, plain_text.lastIndexOf("\""));
		console.log(plain_text);
		document.getElementById("Task_output").innerHTML = plain_text;
		user_log = user_log + plain_text + "\n";
		old = plain_text;
        } else {
		  document.getElementById("Task_output").innerHTML = '';
		  old = "";
        }
      });
  /**
   * Attach an editor to the document
   * @param {Element} The DOM element to attach the ink paper
   * @param {Object} The recognition parameters
   */
  MyScript.register(editorElement, {
    recognitionParams: {
      type: 'TEXT',
      protocol: 'WEBSOCKET',
      apiVersion: 'V4',
      server: {
        scheme: 'https',
        host: 'webdemoapi.myscript.com',
        applicationKey: '515131ab-35fa-411c-bb4d-3917e00faf60',
        hmacKey: '54b2ca8a-6752-469d-87dd-553bb450e9ad'
      },
      v4: {
        text: {
              guides: {
                enable: true
              },
              smartGuide: false
            }

      }
    }
  });

  window.addEventListener('resize', function () {
    editorElement.editor.resize();
  });
  //bruh samo mouse ups and downs
  function handleMouseDown(e) {
  //e.button describes the mouse button that was clicked
  // 0 is left, 1 is middle, 2 is right
  if (e.button === 2) {
    rightMouseClicked = true;
  } else if (e.button === 0) {  
    //Do something if left button was clicked and right button is still pressed
    if (rightMouseClicked) {
      console.log('hello');
      //code
    }
  }
  console.log(rightMouseClicked);
}

function handleMouseUp(e) {
  if (e.button === 2) {
    rightMouseClicked = false;
  }
  console.log(rightMouseClicked);
}

document.addEventListener('mousedown', handleMouseDown);
document.addEventListener('mouseup', handleMouseUp);
document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
});
  
  set_zad();
</script>

	</div>
</body>
</html>